---
title: "Assignment - Linear Mixed Effect"
author: "Dr Mohd Azmi P-UD 0079/19"
date: '`r format(Sys.Date(), "%d %B, %Y")`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F)
options(qwraps2_markup = "markdown", knitr.kable.NA = '')
```

# Motivation

Delayed notification will delay public health action.

In this example, the researcher 


# Environment

## Packages

```{r}
library(pacman) # package manager, elegant way to load packages
p_load(tidyverse, haven, DT, broom, summarytools, knitr, scales, lme4, merTools)
```

## Dataset & Data Exploration



```{r}
lmeds <-  read_sav("mlm_perakndr.sav") %>%
  mutate_if(is.labelled, ~(as_factor(.))) %>%
  na.omit() %>%
  mutate(wt10 = Weight/10, htm = Height/100, dmdur5 = DMDur/5)
lmeds
```

```{r}
lmeds %>% group_by(Daerah_ID) %>% summarise(meanhba1c = mean(fbsa), n = n())
```



# Analysis

## Linear Regression

```{r}
lrmod <- lm(hbaa ~ EthCode + fbsa + wt10 + dmdur5, lmeds)
summary(lrmod)
```


## Linear Mixed Effect

### Null Model

```{r}
lmemodnull <- lmer(hbaa ~ 1 + (1 | Daerah_ID), data = lmeds, REML = F)
summary(lmemodnull)
```


### RI Model

```{r}
lmemodRI <- lmer(hbaa ~ EthCode + fbsa + wt10 + dmdur5 + (1 | Daerah_ID), data = lmeds, REML = F)
summary(lmemodRI)
```

### RI Plot

```{r}
lmemodRI_aug <- augment(lmemodRI)
ggplot(lmemodRI_aug, aes(x = fbsa, y = .fitted, group = Daerah_ID, colour = Daerah_ID)) + geom_point() + geom_line()
```


### RS

```{r}
lmemodRS <- lmer(hbaa ~ EthCode + fbsa + wt10 + dmdur5 + (1 + fbsa | Daerah_ID), lmeds, control = lmerControl(optimizer = "bobyqa"), REML = F)
summary(lmemodRS)
```

### RS Plot

```{r}
lmemodRS_ranef <- ranef(lmemodRS, condVar = T)$Daerah_ID %>% mutate(intercept = `(Intercept)`, slope = fbsa)
ggplot(lmemodRS_ranef, aes(x = intercept, y = slope)) + geom_point() + geom_vline(xintercept = 0) + geom_hline(yintercept = 0)
lattice::dotplot(ranef(lmemodRS, condVar = T))
```

```{r}
lmemodRS_resim <- REsim(lmemodRS)
lmemodRS_resim %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(x = reorder(groupID, median), y = median, ymin = median - 1.96*sd, ymax = median + 1.96*sd)) +
  geom_pointrange() + coord_flip() + ylab("(Intercept)") + xlab("Daerah")
lmemodRS_resim %>%
  filter(term == "fbsa") %>%
  ggplot(aes(x = reorder(groupID, median), y = median, ymin = median - 1.96*sd, ymax = median + 1.96*sd)) +
  geom_pointrange() + coord_flip()+ ylab("fbsa") + xlab("Daerah")
```



### Variance

Between Daerah variance for

1. Null Model = `r round(as.data.frame(VarCorr(lmemodnull))[1,4],4)`
2. RI Model = `r round(as.data.frame(VarCorr(lmemodRI))[1,4],4)`
3. RS Model = `r round(as.data.frame(VarCorr(lmemodRS))[1,4],4)`

Within School variance for

1. Null Model = `r round(as.data.frame(VarCorr(lmemodnull))[2,4],4)`
2. RI Model = `r round(as.data.frame(VarCorr(lmemodRI))[2,4],4)`
3. RS Model = `r round(as.data.frame(VarCorr(lmemodRS))[4,4],4)`

In RI model, proportion of unexplained variance due to differences between Daerah is `r (as.data.frame(VarCorr(lmemodRI))[1,4] / (as.data.frame(VarCorr(lmemodRI))[1,4] + as.data.frame(VarCorr(lmemodRI))[2,4]))*100`%

In RS model, proportion of unexplained variance due to differences between Daerah is `r (as.data.frame(VarCorr(lmemodRS))[1,4] / (as.data.frame(VarCorr(lmemodRS))[1,4] + as.data.frame(VarCorr(lmemodRS))[4,4]))*100`%


```{r}
lmemodnull
```


```{r}
anova(lmemodRI, lmemodRS)
```

## Model Fitness

```{r}
augment(lmemodRS) %>%
  ggplot(aes(x=.fitted, y=.resid)) + geom_point()
```


# Discussion

# Conclusion

# Reference


# Additional Info

Session Info

```{r}
sessionInfo()
```