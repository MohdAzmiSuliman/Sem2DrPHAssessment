---
title: "Assignment - Survival"
author: "Mohd Azmi"
date: "06/07/2020"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F)
options(qwraps2_markup = "markdown", knitr.kable.NA = '')
```

# Motivation

Peritoneal dialysis (PD) is one of renal replacement therapy available for end stage renal failure. However PD require tenckhoff catheterization to access to peritoneal fluid, which have their own risks. There are several technique for tenckhoff catheter placement. In HRPZ II, commonly tenckhoff catheterization was done with either percutaneous or peritonesocopic method.

There are several complications related to tenckhoff catheterization, which generally categorized into infection or mechanical complication. In this analysis, there are several objectives that the researcher would like to achieve

1. the time-to-complication and time-to-removal of the  tenckhoff catheter.
2. compare between percutaneous and peritonescopic method
3. find factors that may affect the time-to-complication and time-to-removal of the  tenckhoff catheter.

Note: 

1. while this research and dataset were based on ongoing research by one of MMed student, the dataset was altered.
2. hence any findings and interpretation from this analysis does not reflect the real outcome of patients in HRPZ and SHOULD NOT be use other than this assignment.

# Environment

## Packages

```{r}
library(pacman) # package manager, elegant way to load packages
p_load(haven, #import spss data
       tidyverse,
       naniar, #replace values with missing
       lubridate, #date manipulation
       summarytools, #data exploration
       DT, #create beautiful data table
       survival, #survival analysis
       broom, #tidy function
       knitr, #knit rmd
       qwraps2, #create beautiful descriptive statistic
       SurvRegCensCov)  
       
```

## Dataset & Data Exploration

Data was saved in SPSS save file, imported to R

```{r}
pdcds0 <- read_sav("pdcsurvivalalter.sav")
pdcds0 %>% 
  arrange(DataID) %>%
  mutate_if(is.labelled, ~(as_factor(.))) %>%
  select(-c(DataID, Comorbidities)) %>%
  datatable(fillContainer = T)
```

data wrangling was done

1. select related variables
2. replace NA for those without recorded date for complication and removal of catheter
3. replace 365 days for duration with no complication nor removal of catheter (as the patient was follow up for maximum 1 year duration)


```{r}
pdcds1 <- pdcds0 %>%
  mutate_if(is.labelled, ~(as_factor(.))) %>%
  arrange(DataID) %>% 
  mutate(RemovalDate2 = as.character(RemovalDate),
         CxDate2 = as.character(CxDate)) %>% 
  replace_with_na(replace = list(RemovalDate2 = "2173-10-13",
                                 CxDate2 = "2173-10-13")) %>%
  mutate(RemovalDate = as.Date(RemovalDate2),
         CxDate = as.Date(CxDate2)) %>%
  mutate(RemovalDur = as.double(difftime(ymd(RemovalDate), ymd(PlaceDate), units = "days")),
         CxDur = as.double(difftime(ymd(CxDate), ymd(PlaceDate), units = "days"))) %>%
  replace_na(list(CxDur = 365, RemovalDur = 365)) %>%
  select(DataID, Gender, Race, Age, CM, CMDM, CMHPT, CMIHD, Method, PlaceDate, Compx, CxTypeCode, CxDate, CxDur, CatheterStatus, RemovalDate, RemovalDur, RemovalReason)

pdcds1 %>% select(-DataID) %>% datatable(fillContainer = T)
```

Simple data exploration to ensure necessary data wrangling was done.

```{r}
pdcds1 %>% select(where(is.factor)) %>% summary() %>% kable()
pdcds1 %>% select(-where(is.factor)) %>% summary() %>% kable()
```

# Analysis & Result

## Descriptive

### Sociodemographic

Descriptive analysis was done on sociodemographic data, was shown below. 

```{r, results='asis'}
demo_sum <- list("Gender" = list("Male" = ~ n_perc0(.data$Gender == "Male"),
                                 "Female" = ~ n_perc0(.data$Gender == "Female")),
                 "Age (years)" = list("Mean (SD)" = ~ mean_sd(.data$Age, denote_sd = "paren")),
                 "Ethnicity" = list("Malay" = ~ n_perc0(.data$Race == "Malay"),
                                    "Non-Malay" = ~ n_perc0(.data$Race == "Non-Malay")),
                 "comorbidities (status)" = list("Yes" = ~ n_perc0(.data$CM == "Yes"),
                                               "No" = ~ n_perc0(.data$CM == "No")),
                 "DM (status)" = list("Yes" = ~ n_perc0(.data$CMDM == "DM"),
                                      "No" = ~ n_perc0(.data$CMDM == "No")),
                 "Hypertension (status)" = list("Yes" = ~ n_perc0(.data$CMHPT == "HPT"),
                                                "No" = ~ n_perc0(.data$CMHPT == "No")),
                 "Ischaemic Heart Disease (status)" = list("Yes" = ~ n_perc0(.data$CMIHD == "IHD"),
                                                           "No" = ~ n_perc0(.data$CMIHD == "No")))
print(summary_table(pdcds1, demo_sum), rtitle = "Variables", cnames = c("Mean (SD) / n (%)"))
```


### Catheterization and Outcomes

out of all the samples, more than half of them underwent percutaneous method, with half of them develop complication (mean complication time = 107 days) and eventually 46% of all catheter require removal (mean removal time = 117 days).

```{r, results='asis'}
pdcds1_withna <- pdcds1 %>%
  replace_with_na(replace = list(RemovalDur = "365", CxDur = "365",
                                 CxTypeCode = "No Complication", RemovalReason = "N/A - Not removed"))
method_sum <- list("Method" = list("Percutaneous Method" = ~ n_perc0(.data$Method == "Percutaneous Method", digits = 1),
                                 "Peritoneoscopy Method" = ~ n_perc0(.data$Method != "Percutaneous Method", digits = 1)),
                   "Complication" = list("Yes" = ~ n_perc0(.data$Compx == "Yes", digits = 1),
                                         "No" = ~ n_perc0(.data$Compx != "Yes", digits = 1)),
                   "Mean Complication Time" = list("Mean (SD)" = ~ mean_sd(.data$CxDur, na_rm = T, show_n = "never",
                                                                           denote_sd = "paren", digits = 2)),
                   "Reason for Complication" = list("Infection Complication" = ~ n_perc0(.data$CxTypeCode == "Infection Complication",
                                                                                         na_rm = T, digits = 1),
                                                    "Mechanical Complication" = ~ n_perc0(.data$CxTypeCode == "Mechanical Complication",
                                                                                          na_rm = T, digits = 1),
                                                    "Both" = ~ n_perc0(.data$CxTypeCode == "Both",
                                                                       na_rm = T, digits = 1)),
                   "Removal" = list("Yes" = ~ n_perc0(.data$CatheterStatus != "censor", digits = 1),
                                    "No" = ~ n_perc0(.data$CatheterStatus == "censor", digits = 1)),
                   "Mean Removal Time" = list("Mean (SD)" = ~ mean_sd(.data$RemovalDur, na_rm = T, show_n = "never",
                                                                      denote_sd = "paren", digits = 2)),
                   "Reason for Removal" = list("Peritonitis" = ~ n_perc0(.data$RemovalReason == "Peritonitis", na_rm = T, digits = 1),
                                               "Exit Site Infection" = ~ n_perc0(.data$RemovalReason == "Exit Site Infection",
                                                                                 na_rm = T, digits = 1),
                                               "Malfunction" = ~ n_perc0(.data$RemovalReason == "Malfunction", na_rm = T, digits = 1)))
print(summary_table(pdcds1_withna, method_sum), rtitle = "Variables", cnames = c("Mean (SD) / n (%)"))
```

Among all the participants, there are 118 samples that developed catheter related complication, ranging from the earliest 13 days post catheterization, and longest reported after 317 days post catheterization.

```{r, results='asis'}
pdcds1 %>% filter(CxDur != 365) %>% descr(CxDur, stats = c("min", "max"))
```

there are 1 to 5 samples developed complication per day. 

```{r}
removaldurdt <- pdcds1 %>% group_by(RemovalDur) %>% count(RemovalDur)
ggplot(removaldurdt, aes(x=RemovalDur, y=n)) +
  geom_point() + geom_line() +
  scale_x_continuous(limits = c(0,364), breaks = seq(0,350,25), expand = c(0,0), name = "Duration of Complication (day)") +
  scale_y_continuous(limits = c(0,6), expand = c(0,0), name = "No. of Patient") +
  theme_bw() + ggtitle("Line of for number of complication for each duration of catheterization")

ggplot(removaldurdt, aes(x=RemovalDur, y=cumsum(n))) +
  geom_point() + geom_line() +
  scale_x_continuous(limits = c(0,364), breaks = seq(0,350,25), expand = c(0,0), name = "Duration of Complication (day)") +
  scale_y_continuous(limits = c(0, 110), expand = c(0,0), name = "No. of Patient (Cumulative)") +
  theme_bw() + ggtitle("Cummulative Frequency Plot for number of complication for each duration of catheterization")
```

Among all the participants, there were 105 catheter that require 

```{r}
pdcds1 %>% filter(RemovalDur != 365) %>% descr(RemovalDur, stats = c("min", "max"))

```


No of catheter remove developed, by number of days

```{r}
cxdurdt <- pdcds1 %>% group_by(CxDur) %>% count(CxDur)
ggplot(cxdurdt, aes(x=CxDur, y=n)) +
  geom_point() + geom_line() +
  scale_x_continuous(limits = c(0,364), name = "Duration of Complication (day)") +
  scale_y_continuous(limits = c(0,5), name = "No. of Patient")
```

```{r}

```

## Survival Analysis

Data will be separate into two dataset, train and test dataset

```{r}
randsel <- sort(sample(nrow(pdcds1),nrow(pdcds1)*.7))
pdcds1_trd <- pdcds1[randsel,]
pdcds1_ted <- pdcds1[-randsel,]
```

As the distribution of the outcome was unknown, Survival Analysis with Weibull model was done.

### Univariable


```{r}
cxsurvweimod_gender <- survreg(Surv(CxDur, Compx == "Yes") ~ Gender, data = pdcds1_trd, dist = "weibull")
summary(cxsurvweimod_gender)
cxsurvweimod_gender_res <- ConvertWeibull(cxsurvweimod_gender, conf.level = 0.95)
cxsurvweimod_gender_res
```

variable gender was not significant, with time ratio (TR) of female (as compare to male) to develop catheter complication was `r cxsurvweimod_gender_res$ETR` times faster. 

```{r}
cxsurvexpmod_method <- survreg(Surv(CxDur, Compx == "Yes") ~ Method, data = pdcds1, dist = "exponential")
summary(cxsurvexpmod_method)
```


Both time-to-event for complication and removal of catheter were analysed using survival analysis
- ethnicity and cm status not included



```{r}
cxsurvexpmod <- survreg(Surv(CxDur, Compx == "Yes") ~ Gender + Age + CMDM + Method, data = pdcds1_trd, dist = "exponential")
summary(cxsurvexpmod)
cxsurvexpmoda <- survreg(Surv(CxDur, Compx == "Yes") ~ Gender + Age + CMDM + Method, data = pdcds1, dist = "exponential")
summary(cxsurvexpmoda)
```
a more elegant way to present it

```{r}
tidy(cxsurvexpmod) %>% 
  mutate(TR = exp(estimate),
         llci = exp(conf.low),
         ulci = exp(conf.high),
         HR = exp(-estimate)) %>% 
  select(term, estimate, TR, llci, ulci, p.value, HR)
```



# Additional Info

```{r}

```




```{r}
sessionInfo()
```

