---
title: "Assignment - Survival"
author: "Mohd Azmi"
date: "06/07/2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
      collapsed: no
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F)
```

# Environment

## Packages

```{r}
library(pacman) # package manager, elegant way to load packages
p_load(haven, #import spss data
       tidyverse,
       naniar, #replace values with missing
       lubridate, #date manipulation
       summarytools, #data exploration
       DT, #create beautiful table
       survival,
       broom,
       knitr)  
       
```

## Dataset

Data was saved in SPSS save file, imported to R

```{r}
pdcds0 <- read_sav("pdcsurvivalalter.sav")
pdcds0 %>% mutate_if(is.labelled, ~(as_factor(.))) %>% select(-c(DataID, Comorbidities)) %>% print() #change to datatable() before knit
```

data wrangling was done

1. select related variables
2. replace NA for those without recorded date for complication and removal of catheter
3. replace 365 days for duration with no complication nor removal of catheter (as the patient was follow up for maximum 1 year duration)



```{r}
pdcds1 <- pdcds0 %>%
  mutate_if(is.labelled, ~(as_factor(.))) %>%
  arrange(DataID) %>% 
  mutate(RemovalDate2 = as.character(RemovalDate),
         CxDate2 = as.character(CxDate)) %>% 
  replace_with_na(replace = list(RemovalDate2 = "2173-10-13",
                                 CxDate2 = "2173-10-13",
                                 RemovalReason = "N/A - Not removed")) %>%
  mutate(RemovalDate = as.Date(RemovalDate2),
         CxDate = as.Date(CxDate2)) %>%
  mutate(RemovalDur = as.double(difftime(ymd(RemovalDate), ymd(PlaceDate), units = "days")),
         CxDur = as.double(difftime(ymd(CxDate), ymd(PlaceDate), units = "days"))) %>%
  replace_na(list(CxDur = 365, RemovalDur = 365)) %>%
  select(DataID, Gender, Race, Age, CM, CMDM, CMHPT, CMIHD, Method, PlaceDate, Compx, CxTypeCode, CxDate, CxDur, CatheterStatus, RemovalDate, RemovalDur)

pdcds1 %>% select(-DataID) %>% datatable()
```

# Analysis

## Data exploration

```{r}
pdcds1 %>% select(Age) %>% summary() %>% kable()
pdcds1 %>% select_if(is.factor) %>% summary() %>% kable()
```

## Sociodemographic



No of complication developed, by number of days

```{r}
pdcds1 %>% filter(RemovalDur != 365) %>% descr(RemovalDur)
removaldurdt <- pdcds1 %>% group_by(RemovalDur) %>% count(RemovalDur)
ggplot(removaldurdt, aes(x=RemovalDur, y=n)) +
  geom_point() + geom_line() +
  scale_x_continuous(limits = c(0,364), name = "Duration of Complication (day)") +
  scale_y_continuous(limits = c(0,5), name = "No. of Patient")
```

No of catheter remove developed, by number of days

```{r}
pdcds1 %>% filter(CxDur != 365) %>% descr(CxDur)
cxdurdt <- pdcds1 %>% group_by(CxDur) %>% count(CxDur)
ggplot(cxdurdt, aes(x=CxDur, y=n)) +
  geom_point() + geom_line() +
  scale_x_continuous(limits = c(0,364), name = "Duration of Complication (day)") +
  scale_y_continuous(limits = c(0,5), name = "No. of Patient")
```

```{r}

```

## Survival Analysis

### Univariable

```{r}
cxsurvexpmod_gender <- survreg(Surv(CxDur, Compx == "Yes") ~ Gender, data = pdcds1, dist = "exponential")
summary(cxsurvexpmod_gender)
```

```{r}
cxsurvexpmod_method <- survreg(Surv(CxDur, Compx == "Yes") ~ Method, data = pdcds1, dist = "exponential")
summary(cxsurvexpmod_method)
```


Both time-to-event for complication and removal of catheter were analysed using survival analysis
- ethnicity and cm status not included



```{r}
cxsurvexpmod <- survreg(Surv(CxDur, Compx == "Yes") ~ Gender + Age + CMDM + Method, data = pdcds1, dist = "exponential")
summary(cxsurvexpmod)
```
a more elegant way to present it

```{r}
tidy(cxsurvexpmod) %>% 
  mutate(TR = exp(estimate),
         llci = exp(conf.low),
         ulci = exp(conf.high),
         HR = exp(-estimate)) %>% 
  select(term, estimate, TR, llci, ulci, p.value, HR)
```



# SessionInfo

```{r}
sessionInfo()
```

